generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  SUPER_ADMIN
  BRANCH_MANAGER
  RECEPTION
  ACCOUNTANT
  PARTNER
}

enum StudentType {
  INTERNAL
  EXTERNAL
}

enum InvoiceType {
  ADMISSION
  MOCK_TEST
  SALE
  EXPENSE
}

enum InvoiceStatus {
  DRAFT
  PARTIAL
  PAID
  VOID
}

enum PartnerShareType {
  PERCENTAGE
  FIXED
}

enum StaffRole {
  TEACHER
  MANAGER
  RECEPTIONIST
  TEA_BOY
  ACCOUNTANT
  OTHER
}

enum PaymentMethod {
  CASH
  CARD
  BANK_TRANSFER
  ONLINE
}

enum CounterScope {
  STUDENT_SERIAL_YEAR
  INVOICE_DAILY
  PARTNER_SETTLEMENT
}

enum AuditAction {
  CREATE
  UPDATE
  VOID
}

model Branch {
  id        String   @id @default(cuid())
  name      String
  code      String   @unique
  timezone  String   @default("Asia/Dhaka")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users           User[]
  students        Student[]
  admissions      Admission[]
  mockTests       MockTest[]
  sales           Sale[]
  invoices        Invoice[]
  payments        Payment[]
  expenses        Expense[]
  staff           Staff[]
  salaryPayments  SalaryPayment[]
  partnerBranches PartnerBranch[]
  counters        Counter[]
}

model User {
  id        String     @id @default(cuid())
  name      String?
  username  String     @unique
  email     String     @unique
  password  String
  role      Role
  branch    Branch?    @relation(fields: [branchId], references: [id])
  branchId  String?
  partner   Partner?   @relation("PartnerUser")
  partnerId String?    @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  auditLogs AuditLog[]
}

model Student {
  id            String      @id @default(cuid())
  studentId     String      @unique
  name          String
  phone         String
  guardianName  String
  guardianPhone String
  type          StudentType
  branch        Branch      @relation(fields: [branchId], references: [id])
  branchId      String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  admissions    Admission[]
  mockTests     MockTest[]
  sales         Sale[]
  invoices      Invoice[]
}

model Admission {
  id        String   @id @default(cuid())
  student   Student  @relation(fields: [studentId], references: [id])
  studentId String
  branch    Branch   @relation(fields: [branchId], references: [id])
  branchId  String
  course    String
  fee       Decimal
  invoice   Invoice  @relation(fields: [invoiceId], references: [id])
  invoiceId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MockTest {
  id          String   @id @default(cuid())
  description String
  student     Student? @relation(fields: [studentId], references: [id])
  studentId   String?
  branch      Branch   @relation(fields: [branchId], references: [id])
  branchId    String
  fee         Decimal
  invoice     Invoice  @relation(fields: [invoiceId], references: [id])
  invoiceId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Sale {
  id          String   @id @default(cuid())
  description String
  student     Student? @relation(fields: [studentId], references: [id])
  studentId   String?
  branch      Branch   @relation(fields: [branchId], references: [id])
  branchId    String
  quantity    Int
  unitPrice   Decimal
  invoice     Invoice  @relation(fields: [invoiceId], references: [id])
  invoiceId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Invoice {
  id            String        @id @default(cuid())
  uuid          String        @unique @default(uuid())
  invoiceNumber String        @unique
  branch        Branch        @relation(fields: [branchId], references: [id])
  branchId      String
  type          InvoiceType
  student       Student?      @relation(fields: [studentId], references: [id])
  studentId     String?
  status        InvoiceStatus @default(DRAFT)
  total         Decimal
  paid          Decimal       @default(0)
  due           Decimal       @default(0)
  issuedAt      DateTime      @default(now())
  voided        Boolean       @default(false)
  voidReason    String?
  items         InvoiceItem[]
  payments      Payment[]
  auditLogs     AuditLog[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  admissions    Admission[]
  mockTests     MockTest[]
  sales         Sale[]
}

model InvoiceItem {
  id          String  @id @default(cuid())
  invoice     Invoice @relation(fields: [invoiceId], references: [id])
  invoiceId   String
  description String
  quantity    Int     @default(1)
  unitPrice   Decimal
  total       Decimal
}

model Payment {
  id         String        @id @default(cuid())
  invoice    Invoice       @relation(fields: [invoiceId], references: [id])
  invoiceId  String
  branch     Branch        @relation(fields: [branchId], references: [id])
  branchId   String
  amount     Decimal
  method     PaymentMethod
  reference  String?
  paidAt     DateTime      @default(now())
  voided     Boolean       @default(false)
  voidReason String?
  auditLogs  AuditLog[]
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
}

model Expense {
  id          String     @id @default(cuid())
  branch      Branch     @relation(fields: [branchId], references: [id])
  branchId    String
  category    String
  amount      Decimal
  description String?
  expenseDate DateTime   @default(now())
  voided      Boolean    @default(false)
  voidReason  String?
  auditLogs   AuditLog[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model Staff {
  id        String          @id @default(cuid())
  branch    Branch          @relation(fields: [branchId], references: [id])
  branchId  String
  name      String
  role      StaffRole
  phone     String?
  hireDate  DateTime        @default(now())
  salary    Decimal
  payments  SalaryPayment[]
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
}

model SalaryPayment {
  id         String     @id @default(cuid())
  staff      Staff      @relation(fields: [staffId], references: [id])
  staffId    String
  branch     Branch     @relation(fields: [branchId], references: [id])
  branchId   String
  month      String
  amount     Decimal
  paidAt     DateTime   @default(now())
  voided     Boolean    @default(false)
  voidReason String?
  auditLogs  AuditLog[]
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
}

model Partner {
  id              String              @id @default(cuid())
  name            String
  email           String              @unique
  phone           String?
  notes           String?
  user            User?               @relation("PartnerUser", fields: [userId], references: [id])
  userId          String?             @unique
  partnerBranches PartnerBranch[]
  settlements     PartnerSettlement[]
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
}

model PartnerBranch {
  id          String              @id @default(cuid())
  partner     Partner             @relation(fields: [partnerId], references: [id])
  partnerId   String
  branch      Branch              @relation(fields: [branchId], references: [id])
  branchId    String
  joinDate    DateTime
  exitDate    DateTime?
  shareType   PartnerShareType
  shareValue  Decimal
  settlements PartnerSettlement[]
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
}

model PartnerSettlement {
  id              String        @id @default(cuid())
  partnerBranch   PartnerBranch @relation(fields: [partnerBranchId], references: [id])
  partnerBranchId String
  month           String
  amount          Decimal
  paid            Boolean       @default(false)
  paidAt          DateTime?
  voided          Boolean       @default(false)
  voidReason      String?
  auditLogs       AuditLog[]
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  partner         Partner?      @relation(fields: [partnerId], references: [id])
  partnerId       String?
}

model AuditLog {
  id                  String             @id @default(cuid())
  entity              String
  entityId            String
  action              AuditAction
  before              Json?
  after               Json?
  reason              String?
  performedBy         User?              @relation(fields: [performedById], references: [id])
  performedById       String?
  createdAt           DateTime           @default(now())
  invoice             Invoice?           @relation(fields: [invoiceId], references: [id])
  invoiceId           String?
  payment             Payment?           @relation(fields: [paymentId], references: [id])
  paymentId           String?
  expense             Expense?           @relation(fields: [expenseId], references: [id])
  expenseId           String?
  salaryPayment       SalaryPayment?     @relation(fields: [salaryPaymentId], references: [id])
  salaryPaymentId     String?
  partnerSettlement   PartnerSettlement? @relation(fields: [partnerSettlementId], references: [id])
  partnerSettlementId String?
}

model Counter {
  id        String       @id @default(cuid())
  branch    Branch       @relation(fields: [branchId], references: [id])
  branchId  String
  scope     CounterScope
  metadata  String?
  value     Int          @default(0)
  year      Int?
  day       Int?
  updatedAt DateTime     @updatedAt

  @@unique([branchId, scope, metadata])
}
